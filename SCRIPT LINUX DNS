#!/bin/bash

# --- CONFIGURACIÓN Y VARIABLES ---
LOG_DNS="/var/log/dns_gestion.log"
INTERFAZ="ens34" # Misma interfaz que tu DHCP
DOMINIO="reprobados.com"
ZONA_FILE="/etc/bind/db.$DOMINIO"
CONF_LOCAL="/etc/bind/named.conf.local"

# --- COLORES Y ESTILOS ---
# Usamos tput para mayor compatibilidad
BOLD=$(tput bold)
RESET=$(tput sgr0)
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
WHITE=$(tput setaf 7)

# --- FUNCIONES AUXILIARES DE DISEÑO ---
header() {
    clear
    echo "${CYAN}╔══════════════════════════════════════════════════════╗${RESET}"
    echo "${CYAN}║           GESTOR DE SERVIDOR DNS (BIND9)             ║${RESET}"
    echo "${CYAN}╠══════════════════════════════════════════════════════╣${RESET}"
    echo "${CYAN}║${RESET} ${YELLOW}Dominio Configurado:${RESET} ${WHITE}$DOMINIO${RESET}"
    echo "${CYAN}║${RESET} ${YELLOW}Interfaz de Red:${RESET}     ${WHITE}$INTERFAZ${RESET}"
    echo "${CYAN}╚══════════════════════════════════════════════════════╝${RESET}"
    echo ""
}

msg_info() {
    echo -e "${BLUE} ➤ ${RESET} $1"
}

msg_ok() {
    echo -e "${GREEN} ✔ ${RESET} $1"
}

msg_warn() {
    echo -e "${YELLOW} ⚠ ${RESET} $1"
}

msg_error() {
    echo -e "${RED} ✘ ${RESET} $1"
}

pause() {
    echo ""
    read -p "${MAGENTA} [ Presiona Enter para continuar ]${RESET}"
}

registrar_log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | sudo tee -a "$LOG_DNS" > /dev/null
}

# --- 1. VERIFICACIÓN DE IP FIJA ---
verificar_ip_fija() {
    msg_info "Verificando configuración de red..."
    
    # Intentamos obtener la IP actual de la interfaz
    IP_ACTUAL=$(ip -4 addr show $INTERFAZ | grep -oP '(?<=inet\s)\d+(\.\d+){3}')

    if [ -z "$IP_ACTUAL" ]; then
        msg_warn "No se detectó IP en $INTERFAZ."
        echo -ne "${YELLOW} Ingrese la IP manual para este servidor:${RESET} "
        read IP_ACTUAL
        sudo ip addr add $IP_ACTUAL/24 dev $INTERFAZ
        sudo ip link set $INTERFAZ up
        registrar_log "IP asignada manualmente: $IP_ACTUAL"
        msg_ok "IP asignada temporalmente: $IP_ACTUAL"
    else
        msg_ok "IP detectada correctamente: ${BOLD}$IP_ACTUAL${RESET}"
    fi
}

# --- 2. INSTALACIÓN IDEMPOTENTE ---
instalar_bind() {
    msg_info "Verificando paquetes necesarios..."
    
    if dpkg -l | grep -q bind9; then
        msg_ok "BIND9 ya está instalado."
    else
        msg_warn "Instalando BIND9 y utilerías (esto puede tardar)..."
        sudo apt-get update -y -qq > /dev/null
        sudo apt-get install bind9 bind9utils bind9-doc -y -qq > /dev/null
        
        if [ $? -eq 0 ]; then
            registrar_log "BIND9 instalado correctamente"
            msg_ok "Instalación completada."
        else
            msg_error "Falló la instalación. Revise su conexión a internet."
        fi
    fi
}

# --- 3. CONFIGURACIÓN DE ZONAS ---
configurar_zonas() {
    msg_info "Configurando zona maestra: ${BOLD}$DOMINIO${RESET}"
    
    # Configurar named.conf.local (Solo si no existe la entrada)
    if ! grep -q "zone \"$DOMINIO\"" "$CONF_LOCAL"; then
        sudo bash -c "cat >> $CONF_LOCAL" <<EOF

zone "$DOMINIO" {
    type master;
    file "$ZONA_FILE";
};
EOF
        msg_ok "Zona añadida a named.conf.local"
    else
        msg_info "La zona ya estaba definida en named.conf.local"
    fi

    # Crear archivo de zona (db.reprobados.com)
    sudo bash -c "cat > $ZONA_FILE" <<EOF
;
; BIND data file for $DOMINIO
;
\$TTL    604800
@       IN      SOA     ns1.$DOMINIO. root.$DOMINIO. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
@       IN      NS      ns1.$DOMINIO.
@       IN      A       $IP_ACTUAL
ns1     IN      A       $IP_ACTUAL
www     IN      A       $IP_ACTUAL
EOF
    
    registrar_log "Zona $DOMINIO configurada apuntando a $IP_ACTUAL"
    sudo systemctl restart bind9
    msg_ok "Archivo de zona creado y servicio reiniciado."
}

# --- 4. VALIDACIÓN Y PRUEBAS ---
validar_configuracion() {
    echo ""
    echo "${CYAN}--- EJECUTANDO PRUEBAS DE VALIDACIÓN ---${RESET}"
    
    # Prueba de sintaxis
    if named-checkconf > /dev/null; then
        msg_ok "Sintaxis de configuración BIND: CORRECTA"
    else
        msg_error "Error de sintaxis en BIND. Revise los logs."
    fi

    # Prueba de resolución local
    msg_info "Probando resolución DNS local..."
    sleep 2
    
    RESULTADO=$(nslookup $DOMINIO 127.0.0.1 2>/dev/null | grep "Address:" | tail -n1 | awk '{print $2}')
    
    if [ "$RESULTADO" == "$IP_ACTUAL" ]; then
        msg_ok "Resolución exitosa: $DOMINIO -> $RESULTADO"
    else
        msg_error "Fallo en resolución. Se obtuvo: '$RESULTADO' (Esperado: $IP_ACTUAL)"
        msg_warn "Asegúrese de que el puerto 53 no esté bloqueado."
    fi
}

# --- 5. MOSTRAR ESTADO DE ZONA ---
mostrar_estado_zona() {
    header
    echo "${MAGENTA}>>> CONTENIDO DEL ARCHIVO DE ZONA ($ZONA_FILE)${RESET}"
    echo ""
    if [ -f "$ZONA_FILE" ]; then
        cat "$ZONA_FILE" | grep -v ";" | grep -v "^$" # Muestra limpio sin comentarios
    else
        msg_error "El archivo de zona no existe aún."
    fi
    echo ""
}

# --- MENÚ PRINCIPAL ---
while true; do
    header
    echo "${GREEN}  1.${RESET} Verificar Instalación y Red"
    echo "${GREEN}  2.${RESET} Instalar y Configurar DNS (Automático)"
    echo "${GREEN}  3.${RESET} Reconfigurar IP del Servidor"
    echo "${GREEN}  4.${RESET} Ver Estado de la Zona (Registros)"
    echo "${GREEN}  5.${RESET} Salir"
    echo ""
    echo -n "${CYAN}  Seleccione una opción [1-5]: ${RESET}"
    read opt

    case $opt in
        1)
            header
            instalar_bind
            verificar_ip_fija
            pause
            ;;
        2)
            header
            verificar_ip_fija
            instalar_bind
            configurar_zonas
            validar_configuracion
            pause
            ;;
        3)
            header
            echo -ne "${YELLOW} Ingrese nueva IP para los registros: ${RESET}"
            read IP_ACTUAL
            configurar_zonas
            validar_configuracion
            pause
            ;;
        4)
            mostrar_estado_zona
            pause
            ;;
        5)
            echo ""
            msg_info "Saliendo del sistema..."
            exit 0
            ;;
        *)
            msg_error "Opción no válida."
            sleep 1
            ;;
    esac
done
