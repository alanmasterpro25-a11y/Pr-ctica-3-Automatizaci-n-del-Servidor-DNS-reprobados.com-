# ===============================
# CONFIGURACION GENERAL
# ===============================

function Obtener-IP($iface) {
    (Get-NetIPAddress -InterfaceAlias $iface -AddressFamily IPv4 |
     Where-Object {$_.IPAddress -notlike "169.*"}).IPAddress
}

# ===============================
# FUNCIONES
# ===============================

function Verificar-DNS {

    Write-Host "Verificando instalación..."

    $dns = Get-WindowsFeature -Name DNS

    if ($dns.Installed) {
        Write-Host "DNS instalado"
        Get-Service DNS
    }
    else {
        Write-Host "DNS NO instalado"
    }
}

function Instalar-DNS {

    Write-Host "Instalando DNS..."

    Install-WindowsFeature -Name DNS -IncludeManagementTools

    Start-Service DNS

    Write-Host "DNS instalado"
}

function Configurar-DNS {
    $forward = Read-Host "IP Forwarder (ej: 8.8.8.8)"
    
    Start-Sleep -Seconds 2
    
    try {
        Set-DnsServerForwarder -IPAddress ([string[]]$forward) -PassThru -ErrorAction Stop
        Write-Host "Forwarder configurado con Set-DnsServerForwarder"
    } catch {
        Write-Host "Intentando metodo alternativo..."
        Add-DnsServerForwarder -IPAddress $forward
        Write-Host "Forwarder configurado con Add-DnsServerForwarder"
    }
    
    Restart-Service DNS
    Write-Host "DNS configurado"
}

function Listar-Dominios {

    Write-Host "=== DOMINIOS CONFIGURADOS ==="

    Get-DnsServerZone | Select ZoneName, ZoneType
}

function Agregar-Dominio {

    $dom = Read-Host "Nombre dominio (ej: midominio.local)"

    Write-Host ""
    Write-Host "Interfaces disponibles:"
    #Get-NetAdapter | Select Name
    Get-NetAdapter | Select-Object -ExpandProperty Name

    $iface = Read-Host "Interfaz de red"

    $ip = Obtener-IP $iface

    if (!$ip) {
        Write-Host "No se pudo obtener IP"
        return
    }

    Write-Host "IP detectada: $ip"

    $www = Read-Host "Agregar www? (s/n)"

    # Crear zona
    Add-DnsServerPrimaryZone -Name $dom -ZoneFile "$dom.dns"

    # Registro principal
    Add-DnsServerResourceRecordA -Name "@" -ZoneName $dom -IPv4Address $ip

    # ns
    Add-DnsServerResourceRecordA -Name "ns" -ZoneName $dom -IPv4Address $ip

    if ($www -eq "s") {
        Add-DnsServerResourceRecordA -Name "www" -ZoneName $dom -IPv4Address $ip
    }

    Restart-Service DNS

    Write-Host "Dominio agregado"
}

function Borrar-Dominio {

    $dom = Read-Host "Dominio a eliminar"

    Remove-DnsServerZone -Name $dom -Force

    Restart-Service DNS

    Write-Host "Dominio eliminado"
}

function Consultar-DNS {

    $dom = Read-Host "Dominio a consultar"

    Resolve-DnsName $dom
}

# ===============================
# MENU PRINCIPAL
# ===============================

while ($true) {

Clear-Host
Write-Host "========== MENU DNS =========="
Write-Host "1. Verificar instalación"
Write-Host "2. Instalar DNS"
Write-Host "3. Configurar DNS"
Write-Host "4. ABC dominios"
Write-Host "5. Salir"

$op = Read-Host "Seleccione"

switch ($op) {

"1" { Verificar-DNS }
"2" { Instalar-DNS }
"3" { Configurar-DNS }

"4" {

    Clear-Host
    Write-Host "=== ABC DOMINIOS ==="
    Write-Host "1. Enlistar"
    Write-Host "2. Agregar"
    Write-Host "3. Quitar"
    Write-Host "4. Consultar"

    $sub = Read-Host "Opcion"

    switch ($sub) {
        "1" { Listar-Dominios }
        "2" { Agregar-Dominio }
        "3" { Borrar-Dominio }
        "4" { Consultar-DNS }
    }
}

"5" { exit }

}

Read-Host "ENTER para continuar..."

}
